var Im = Im || {};
Im.newMessageCache = Im.newMessageCache || [];
Im.soundNotificationsEnabled = !localStorage.getItem('im_sf_disabled');

!function ($, window, document, _undefined) {

    function declOfNum(number, titles) {
        cases = [2, 0, 1, 1, 1, 2];
        return titles[(number % 100 > 4 && number % 100 < 20) ? 2 : cases[(number % 10 < 5) ? number % 10 : 5]];
    }

    var SoundNotification = {
        audio: undefined,

        play: function () {
            if (Im.soundNotificationsEnabled) {

                if (!self.audio) {
                    self.audio = new Audio(Im.soundNotificationFile);
                }

                self.audio.play();
            }
        }
    };

    var titleChanged, newMessagePhrase, origTitle;

    var TabControl = {
        tabVisibilityChanged: function () {
            if (this.tabIsHidden()) {
                // tab is hidden
            } else {

            }
        },

        getHiddenProp: function () {
            var prefixes = ['webkit', 'moz', 'ms', 'o'];

            if ('hidden' in document) return 'hidden';

            for (var i = 0; i < prefixes.length; i++) {
                if ((prefixes[i] + 'Hidden') in document)
                    return prefixes[i] + 'Hidden';
            }

            return null;
        },

        monitorTabVisibility: function () {
            var visProp = this.getHiddenProp(),
                self = this;
            if (visProp) {
                var evtname = visProp.replace(/[H|h]idden/, '') + 'visibilitychange';
                document.addEventListener(evtname, function () {
                    self.tabVisibilityChanged();
                });
            }
        },

        tabIsHidden: function () {
            var prop = this.getHiddenProp();
            if (!prop) return false;

            return document[prop];
        }
    };


    Im.Notification = function () {
        this.__construct();
    };
    Im.Notification.prototype = {
        __construct: function () {
            this.pushstream = new PushStream({
                host: Im.host,
                port: Im.port,
                modes: "longpolling",
                useSSL: Im.ssl
            });

            this.pushstream.onmessage = $.context(this, 'pushStreamMessageReceived');
            this.addVisitorChannel();
            this.changeTitleTimer = undefined;
            this.soundNotificationAudio = undefined;
        },

        addVisitorChannel: function () {
            this.pushstream.addChannel(Im.visitorChannelId);
            this.pushstream.connect();
        },

        pushStreamMessageReceived: function (data, id, channel) {
           
            try
            {
                data = JSON.parse(data);
            }
            catch (e) {

            }
            
            if (data.user_id !== XenForo.visitor.user_id) {
                switch (data.do) {
                    case 'new_message':
                        this.eventNewMessage(data);
                        break;
                    case 'telegram_notifications_enabled':
                        this.telegramNotificationsEnabled(data);
                        break;
                }
            }
        },


        changeTitle: function () {
            if (titleChanged) {
                document.title = origTitle;
            } else {
                document.title = newMessagePhrase;
            }

            titleChanged = !titleChanged;
        },


        eventNewMessage: function (data) {
            var temp = $(data.message.templateHtml);
            temp.find('.messageText').find('a').replaceWith(function(){
                return $("<span />", {html: $(this).html()});
            });

            data.message.templateHtml = temp.prop("outerHTML");

            var $templateHtml = $(data.message.templateHtml);

            var notificationData = {
                'conversationId': data.conversation_id,
                'content': $templateHtml.find('.messageText').html().replace(/<br>/g, ' '),
                'usernameClass': $templateHtml.find('.username').children().attr('class'),
                'senderUsername': $templateHtml.find('.username').text(),
                'senderAvatarSrc': $templateHtml.find('.avatar img').attr('src'),
                'notificationId': XenForo.uniqueId()
            };

            var notificationTemplateHtml = $('#NotificationTemplate').html();

            var renderedHtml = Mustache.to_html(notificationTemplateHtml, notificationData);

            if (!Im.newMessageCache[data.conversationId]) {
                Im.newMessageCache.push(data.conversationId);
                newMessagePhrase = Im.newMessageCache.length.toString() + ' ' + declOfNum(Im.newMessageCache.length, Im.newMessagePhrases);
                origTitle = origTitle || document.title;

                if (this.changeTitleTimer) clearInterval(this.changeTitleTimer);
                if (TabControl.tabIsHidden()) {
                    this.changeTitle();

                    this.changeTitleTimer = setInterval(function () {
                        this.changeTitle();
                    }.bind(this), 1500);

                    SoundNotification.play();
                }


            }

            XenForo.stackAlert($(renderedHtml), 0);

            var AutoOverlayClosingTimeout;
            var $form = $('#imn-' + notificationData.notificationId).find('.ImNotification--QuickReplyForm');

            var SetAutoOverlayClosing = function () {
                AutoOverlayClosingTimeout = setTimeout(function () {
                    $form.closest('.DismissParent').find('a.DismissCtrl').trigger('click');
                }, 10000);
            };

            if (!TabControl.tabIsHidden()) {
                // Tab is visible
                SetAutoOverlayClosing();
            } else {
                /// Tab is hidden
                var checkTabInterval = setInterval(function () {
                    if (!TabControl.tabIsHidden()) {
                        // Tab is visible
                        clearInterval(checkTabInterval);
                        SetAutoOverlayClosing();
                        if (this.changeTitleTimer) clearInterval(this.changeTitleTimer);
                        if (titleChanged) {
                            document.title = origTitle;
                        }
                    }
                }.bind(this), 500);
            }


            if ($form.length) {
                $form.find('.MessageCtrl').on('keydown', function (e) {
                    if (e.which === 13) {
                        e.preventDefault();

                        XenForo.ajax($form.attr('action'), $form.serializeArray(), function (ajaxData) {
                            if (!XenForo.hasResponseError(ajaxData)) {
                                $form.closest('.DismissParent').find('a.DismissCtrl').trigger('click'); // hide notification;
                                Im.newMessageCache.unshift(data.conversationId);
                            }
                        });


                        XenForo.alert(Im.messageSentPhraseAlert.replace('{{user}}', notificationData.senderUsername), '', 3000);
                    }
                })
                    .on('focus', () => clearTimeout(AutoOverlayClosingTimeout))
                    .on('blur', () => SetAutoOverlayClosing());
            }


        },

        telegramNotificationsEnabled: function (data) {
            if (window.location.href.indexOf('alert-preferences') > 0) {
                window.location.reload();
            }
        },
    };


    $(window).on('load', function () {
        if (!$('#content').hasClass('conversation_list')) {
            // Visitor is viewing non conversations page
            XenForo.create('Im.Notification', 'html');
        }
    });

    Im.ConversationsPopupLink = function ($link) {

        $link.parent().removeClass('Popup PopupControl PopupContainerControl');
        $link.on('click', function (e) {
            e.preventDefault(e);
            document.location.href = $link.attr('href');
        })
    };

    Im.ReadAll = function ($link) {
        $link.on('click', function (e) {
            e.preventDefault();

            XenForo.ajax($link.attr('href'), {}, function (ajaxData) {
                if (!XenForo.hasResponseError(ajaxData))
                {
                    $('.conversationItem.unread').removeClass('unread');
                    $('.ImReadAll').children().removeClass(ajaxData.removeClass).addClass(ajaxData.addClass);
                }
            });
        });
    };

    if ($('html').hasClass('LoggedIn'))
    {
        if (XenForo.isTouchBrowser())
        {
            XenForo.register('#ConversationsPopupLink', 'Im.ConversationsPopupLink');
        }

        XenForo.register('.ImReadAll', 'Im.ReadAll');
    }



}(jQuery, this, document);