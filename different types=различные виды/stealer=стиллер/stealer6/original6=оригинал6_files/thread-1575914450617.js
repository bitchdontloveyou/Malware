!function($,window,document,_undefined){if(typeof Waindigo==="undefined"){Waindigo={};}var liveThreadRemoveInProgress=false;$.extend(Waindigo,{liveThreadsOptions:{},quickReplyInProgress:false,quickReplyCount:0,messageSinceReplyingInProgress:false}),Waindigo.NewMessageLoader=function($ctrl){if(!Waindigo.quickReplyInProgress&&!Waindigo.messageSinceReplyingInProgress){if($ctrl.parent().hasClass("messagesSinceReplyingNotice")){Waindigo.messageSinceReplyingInProgress=true;XenForo.ajax($ctrl.data("href")||$ctrl.attr("href"),{},function(ajaxData){if(XenForo.hasResponseError(ajaxData)){return false;}var $form=$("#QuickReply"),$messageList=$("#messageList");$('input[name="last_date"]',$form).val(ajaxData.lastDate);new XenForo.ExtLoader(ajaxData,function(){$messageList.find(".messagesSinceReplyingNotice").remove();$(ajaxData.templateHtml).each(function(){if(this.tagName){$(this).xfInsert("appendTo",$messageList);}});});Waindigo.messageSinceReplyingInProgress=false;});}}};Waindigo.MessageInfo=function($messageInfo){id=$messageInfo.parent().attr("id");if($("li[id="+id+"]").length>1){$messageInfo.parent().remove();}function removeIfMoreThan20Messages(){if(liveThreadRemoveInProgress){return;}liveThreadRemoveInProgress=true;var messages=$(".messageList > .message:not(.deleted)").length;if(messages>20){$(".messageList > .message:not(.deleted)").first().remove(null,function(){liveThreadRemoveInProgress=false;removeIfMoreThan20Messages();});}else{liveThreadRemoveInProgress=false;}}};if(XenForo.BbCodeWysiwygEditor!==undefined){var Super=XenForo.BbCodeWysiwygEditor.prototype;$.extend(XenForo.BbCodeWysiwygEditor.prototype,{_superConstruct:Super.__construct,__construct:function($textarea){this._superConstruct($textarea);this.initLiveRefresh();},initLiveRefresh:function(){var self=this,$form=this.$textarea.closest("form");if(!$form.length){return;}refreshFrequency=this.getRefreshFrequency();window.setTimeout(function(){self.liveRefresh();},refreshFrequency*1000);},liveRefresh:function(){var self=this,$form=this.$textarea.closest("form");flagId=Waindigo.quickReplyCount;if(!Waindigo.quickReplyInProgress&&!Waindigo.messageSinceReplyingInProgress&&!this.autoSaveRunning){this.autoSaveRunning=true;XenForo.ajax(Waindigo.liveThreadsOptions.liveRefreshUrl,$form.serialize(),function(ajaxData){if(!Waindigo.quickReplyInProgress&&flagId==Waindigo.quickReplyCount){var e=$.Event("BbCodeWysiwygEditorAutoSaveComplete");e.ajaxData=ajaxData;$form.trigger(e);}},{global:false}).complete(function(){self.autoSaveRunning=false;refreshFrequency=self.getRefreshFrequency();window.setTimeout(function(){self.liveRefresh();},refreshFrequency*1000);});}else{refreshFrequency=this.getRefreshFrequency();window.setTimeout(function(){self.liveRefresh();},refreshFrequency*1000);}return true;},getRefreshFrequency:function(){lastDate=$("input[name=last_date]").val();if(!Date.now){Date.now=function(){return new Date().getTime();};}secondsSinceLastPost=Math.floor(Date.now()/1000)-lastDate;refreshFrequency=Math.max(1,Waindigo.liveThreadsOptions.refreshFrequencyMinimum,secondsSinceLastPost/10);refreshFrequency=Math.min(Waindigo.liveThreadsOptions.refreshFrequencyMaximum,refreshFrequency);return refreshFrequency;}});}Waindigo.QuickReply=function($form){$form.data("WaindigoQuickReply",this).bind({AutoValidationBeforeSubmit:function(e){var $messageList=$("#messageList"),$notice=$messageList.find(".messagesSinceReplyingNotice");if($notice.length){$notice.remove();}Waindigo.quickReplyInProgress=true;Waindigo.quickReplyCount=Waindigo.quickReplyCount+1;},AutoValidationComplete:function(e){Waindigo.quickReplyInProgress=false;}});};XenForo.register(".NewMessageLoader","Waindigo.NewMessageLoader");XenForo.register(".messageInfo","Waindigo.MessageInfo");XenForo.register("#QuickReply","Waindigo.QuickReply");}(jQuery,this,document);